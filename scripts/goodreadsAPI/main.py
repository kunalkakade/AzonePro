import re
import xml.etree.ElementTree as ET
import pprint
import json
import zlib
from elasticsearch import Elasticsearch
import requests
import base64
import logging


# Log transport details (optional):
logging.basicConfig(level=logging.INFO)

SEARCH_TAG_LIST = ['original_publication_year', 'original_publication_month',
                   'original_publication_day', 'average_rating', "title",
                   "name", "image_url", "small_image_url"]

BONSAI_URL = "https://m4298xjdus:mhavgiv2ll@twitter-kafka-1036075227.us-west-2.bonsaisearch.net:443"

KEY = "OviLS6XbejobFRKgB5SRg"
BASE_URL = "https://www.goodreads.com/search/index.xml"

SAMPLE_URL = "https://www.goodreads.com/search/index.xml?key=OviLS6XbejobFRKgB5SRg&q=potter"

dd = '<?xml version="1.0" encoding="UTF-8"?>\n<GoodreadsResponse>\n  <Request>\n    <authentication>true</authentication>\n      <key><![CDATA[OviLS6XbejobFRKgB5SRg]]></key>\n    <method><![CDATA[search_index]]></method>\n  </Request>\n  <search>\n  <query><![CDATA[Ender\'s Game]]></query>\n    <results-start>1</results-start>\n    <results-end>20</results-end>\n    <total-results>751</total-results>\n    <source>Goodreads</source>\n    <query-time-seconds>0.05</query-time-seconds>\n    <results>\n        <work>\n  <id type="integer">2422333</id>\n  <books_count type="integer">254</books_count>\n  <ratings_count type="integer">1089619</ratings_count>\n  <text_reviews_count type="integer">42590</text_reviews_count>\n  <original_publication_year type="integer">1985</original_publication_year>\n  <original_publication_month type="integer" nil="true"/>\n  <original_publication_day type="integer" nil="true"/>\n  <average_rating>4.30</average_rating>\n  <best_book type="Book">\n    <id type="integer">375802</id>\n    <title>Ender\xe2\x80\x99s Game (Ender\xe2\x80\x99s Saga, #1)</title>\n    <author>\n      <id type="integer">589</id>\n      <name>Orson Scott Card</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1408303130l/375802._SY160_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1408303130l/375802._SY75_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">938064</id>\n  <books_count type="integer">65</books_count>\n  <ratings_count type="integer">83149</ratings_count>\n  <text_reviews_count type="integer">883</text_reviews_count>\n  <original_publication_year type="integer">1984</original_publication_year>\n  <original_publication_month type="integer">12</original_publication_month>\n  <original_publication_day type="integer" nil="true"/>\n  <average_rating>4.18</average_rating>\n  <best_book type="Book">\n    <id type="integer">44687</id>\n    <title>Enchanters\' End Game (The Belgariad, #5)</title>\n    <author>\n      <id type="integer">8732</id>\n      <name>David Eddings</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1217735909l/44687._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1217735909l/44687._SY75_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">6581562</id>\n  <books_count type="integer">5</books_count>\n  <ratings_count type="integer">35810</ratings_count>\n  <text_reviews_count type="integer">238</text_reviews_count>\n  <original_publication_year type="integer">2009</original_publication_year>\n  <original_publication_month type="integer" nil="true"/>\n  <original_publication_day type="integer" nil="true"/>\n  <average_rating>4.39</average_rating>\n  <best_book type="Book">\n    <id type="integer">6393082</id>\n    <title>Ender\'s Game, Volume 1: Battle School (Ender\'s Saga)</title>\n    <author>\n      <id type="integer">38491</id>\n      <name>Christopher Yost</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">55447683</id>\n  <books_count type="integer">46</books_count>\n  <ratings_count type="integer">32802</ratings_count>\n  <text_reviews_count type="integer">2092</text_reviews_count>\n  <original_publication_year type="integer">2017</original_publication_year>\n  <original_publication_month type="integer">11</original_publication_month>\n  <original_publication_day type="integer">14</original_publication_day>\n  <average_rating>4.15</average_rating>\n  <best_book type="Book">\n    <id type="integer">34368113</id>\n    <title>End Game (Will Robie, #5)</title>\n    <author>\n      <id type="integer">9291</id>\n      <name>David Baldacci</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1495976812l/34368113._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1495976812l/34368113._SY75_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">43992</id>\n  <books_count type="integer">7</books_count>\n  <ratings_count type="integer">14113</ratings_count>\n  <text_reviews_count type="integer">245</text_reviews_count>\n  <original_publication_year type="integer">1984</original_publication_year>\n  <original_publication_month type="integer" nil="true"/>\n  <original_publication_day type="integer" nil="true"/>\n  <average_rating>4.27</average_rating>\n  <best_book type="Book">\n    <id type="integer">44660</id>\n    <title>The Belgariad Boxed Set: Pawn of Prophecy / Queen of Sorcery / Magician\'s Gambit / Castle of Wizardry / Enchanters\' End Game (The Belgariad, #1-5)</title>\n    <author>\n      <id type="integer">8732</id>\n      <name>David Eddings</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1391347386l/44660._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1391347386l/44660._SX50_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">7272274</id>\n  <books_count type="integer">3</books_count>\n  <ratings_count type="integer">15143</ratings_count>\n  <text_reviews_count type="integer">56</text_reviews_count>\n  <original_publication_year type="integer">2010</original_publication_year>\n  <original_publication_month type="integer">3</original_publication_month>\n  <original_publication_day type="integer">24</original_publication_day>\n  <average_rating>4.60</average_rating>\n  <best_book type="Book">\n    <id type="integer">7025086</id>\n    <title>Ender\'s Game, Volume 2: Command School</title>\n    <author>\n      <id type="integer">38491</id>\n      <name>Christopher Yost</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">56291562</id>\n  <books_count type="integer">7</books_count>\n  <ratings_count type="integer">7030</ratings_count>\n  <text_reviews_count type="integer">369</text_reviews_count>\n  <original_publication_year type="integer">2017</original_publication_year>\n  <original_publication_month type="integer">7</original_publication_month>\n  <original_publication_day type="integer">9</original_publication_day>\n  <average_rating>4.17</average_rating>\n  <best_book type="Book">\n    <id type="integer">35010791</id>\n    <title>The Gender End (The Gender Game, #7)</title>\n    <author>\n      <id type="integer">6860531</id>\n      <name>Bella Forrest</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">42437887</id>\n  <books_count type="integer">7</books_count>\n  <ratings_count type="integer">5479</ratings_count>\n  <text_reviews_count type="integer">670</text_reviews_count>\n  <original_publication_year type="integer">2015</original_publication_year>\n  <original_publication_month type="integer">9</original_publication_month>\n  <original_publication_day type="integer">8</original_publication_day>\n  <average_rating>4.11</average_rating>\n  <best_book type="Book">\n    <id type="integer">22874150</id>\n    <title>The End Game</title>\n    <author>\n      <id type="integer">6876994</id>\n      <name>Kate  McCarthy</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1423089153l/22874150._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1423089153l/22874150._SY75_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">938065</id>\n  <books_count type="integer">10</books_count>\n  <ratings_count type="integer">7331</ratings_count>\n  <text_reviews_count type="integer">146</text_reviews_count>\n  <original_publication_year type="integer">1980</original_publication_year>\n  <original_publication_month type="integer">1</original_publication_month>\n  <original_publication_day type="integer">1</original_publication_day>\n  <average_rating>4.39</average_rating>\n  <best_book type="Book">\n    <id type="integer">18879</id>\n    <title>The Belgariad, Vol. Two: Castle of Wizardry / Enchanters\' End Game (The Belgariad, #4-5)</title>\n    <author>\n      <id type="integer">8732</id>\n      <name>David Eddings</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">44223038</id>\n  <books_count type="integer">20</books_count>\n  <ratings_count type="integer">6223</ratings_count>\n  <text_reviews_count type="integer">474</text_reviews_count>\n  <original_publication_year type="integer">2015</original_publication_year>\n  <original_publication_month type="integer">9</original_publication_month>\n  <original_publication_day type="integer">15</original_publication_day>\n  <average_rating>4.27</average_rating>\n  <best_book type="Book">\n    <id type="integer">24611928</id>\n    <title>The End Game (A Brit in the FBI, #3)</title>\n    <author>\n      <id type="integer">1239</id>\n      <name>Catherine Coulter</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1425319746l/24611928._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1425319746l/24611928._SX50_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">56238306</id>\n  <books_count type="integer">5</books_count>\n  <ratings_count type="integer">2477</ratings_count>\n  <text_reviews_count type="integer">91</text_reviews_count>\n  <original_publication_year type="integer">2017</original_publication_year>\n  <original_publication_month type="integer">4</original_publication_month>\n  <original_publication_day type="integer">24</original_publication_day>\n  <average_rating>4.32</average_rating>\n  <best_book type="Book">\n    <id type="integer">34963329</id>\n    <title>End Game (Jack Noble #12)</title>\n    <author>\n      <id type="integer">6151659</id>\n      <name>L.T. Ryan</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">66029652</id>\n  <books_count type="integer">3</books_count>\n  <ratings_count type="integer">1389</ratings_count>\n  <text_reviews_count type="integer">151</text_reviews_count>\n  <original_publication_year type="integer" nil="true"/>\n  <original_publication_month type="integer" nil="true"/>\n  <original_publication_day type="integer" nil="true"/>\n  <average_rating>4.03</average_rating>\n  <best_book type="Book">\n    <id type="integer">42372731</id>\n    <title>The End Game (Love Games #2)</title>\n    <author>\n      <id type="integer">15996299</id>\n      <name>Mickey Miller</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">51609213</id>\n  <books_count type="integer">8</books_count>\n  <ratings_count type="integer">1228</ratings_count>\n  <text_reviews_count type="integer">277</text_reviews_count>\n  <original_publication_year type="integer">2018</original_publication_year>\n  <original_publication_month type="integer">1</original_publication_month>\n  <original_publication_day type="integer">2</original_publication_day>\n  <average_rating>4.21</average_rating>\n  <best_book type="Book">\n    <id type="integer">30985221</id>\n    <title>End Game (Dirty Money, #4)</title>\n    <author>\n      <id type="integer">73977</id>\n      <name>Lisa Renee Jones</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1497740135l/30985221._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1497740135l/30985221._SX50_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">53830455</id>\n  <books_count type="integer">5</books_count>\n  <ratings_count type="integer">2286</ratings_count>\n  <text_reviews_count type="integer">164</text_reviews_count>\n  <original_publication_year type="integer">2016</original_publication_year>\n  <original_publication_month type="integer">11</original_publication_month>\n  <original_publication_day type="integer">27</original_publication_day>\n  <average_rating>4.42</average_rating>\n  <best_book type="Book">\n    <id type="integer">33144572</id>\n    <title>End Game (Fallen Empire, #8)</title>\n    <author>\n      <id type="integer">4512224</id>\n      <name>Lindsay Buroker</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">61846440</id>\n  <books_count type="integer">2</books_count>\n  <ratings_count type="integer">1276</ratings_count>\n  <text_reviews_count type="integer">236</text_reviews_count>\n  <original_publication_year type="integer">2018</original_publication_year>\n  <original_publication_month type="integer">5</original_publication_month>\n  <original_publication_day type="integer">23</original_publication_day>\n  <average_rating>4.40</average_rating>\n  <best_book type="Book">\n    <id type="integer">39947220</id>\n    <title>End Game (Bellevue Bullies, #4)</title>\n    <author>\n      <id type="integer">5255580</id>\n      <name>Toni Aleo</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1526291653l/39947220._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1526291653l/39947220._SY75_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">19174329</id>\n  <books_count type="integer">10</books_count>\n  <ratings_count type="integer">601</ratings_count>\n  <text_reviews_count type="integer">111</text_reviews_count>\n  <original_publication_year type="integer">2013</original_publication_year>\n  <original_publication_month type="integer">1</original_publication_month>\n  <original_publication_day type="integer">1</original_publication_day>\n  <average_rating>3.74</average_rating>\n  <best_book type="Book">\n    <id type="integer">13586977</id>\n    <title>Ender\'s World: Fresh Perspectives on the SF Classic Ender\'s Game</title>\n    <author>\n      <id type="integer">589</id>\n      <name>Orson Scott Card</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1344608510l/13586977._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1344608510l/13586977._SX50_.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">12531</id>\n  <books_count type="integer">1</books_count>\n  <ratings_count type="integer">1889</ratings_count>\n  <text_reviews_count type="integer">87</text_reviews_count>\n  <original_publication_year type="integer">2001</original_publication_year>\n  <original_publication_month type="integer">10</original_publication_month>\n  <original_publication_day type="integer">14</original_publication_day>\n  <average_rating>4.22</average_rating>\n  <best_book type="Book">\n    <id type="integer">9736</id>\n    <title>Beyond Ender\'s Game: Speaker for the Dead, Xenocide, Children of the Mind (Ender\'s Saga, #2-4)</title>\n    <author>\n      <id type="integer">589</id>\n      <name>Orson Scott Card</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">12530</id>\n  <books_count type="integer">3</books_count>\n  <ratings_count type="integer">1905</ratings_count>\n  <text_reviews_count type="integer">60</text_reviews_count>\n  <original_publication_year type="integer">2002</original_publication_year>\n  <original_publication_month type="integer">9</original_publication_month>\n  <original_publication_day type="integer">16</original_publication_day>\n  <average_rating>4.49</average_rating>\n  <best_book type="Book">\n    <id type="integer">9735</id>\n    <title>Ender\'s Game Boxed Set: Ender\'s Game, Ender\'s Shadow, Shadow of the Hegemon</title>\n    <author>\n      <id type="integer">589</id>\n      <name>Orson Scott Card</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">56991591</id>\n  <books_count type="integer">5</books_count>\n  <ratings_count type="integer">1325</ratings_count>\n  <text_reviews_count type="integer">66</text_reviews_count>\n  <original_publication_year type="integer">2017</original_publication_year>\n  <original_publication_month type="integer">7</original_publication_month>\n  <original_publication_day type="integer">7</original_publication_day>\n  <average_rating>4.27</average_rating>\n  <best_book type="Book">\n    <id type="integer">35623296</id>\n    <title>End Game</title>\n    <author>\n      <id type="integer">6422267</id>\n      <name>Charlie Gallagher</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type="integer">71051396</id>\n  <books_count type="integer">4</books_count>\n  <ratings_count type="integer">330</ratings_count>\n  <text_reviews_count type="integer">192</text_reviews_count>\n  <original_publication_year type="integer">2020</original_publication_year>\n  <original_publication_month type="integer">1</original_publication_month>\n  <original_publication_day type="integer" nil="true"/>\n  <average_rating>4.24</average_rating>\n  <best_book type="Book">\n    <id type="integer">46125032</id>\n    <title>End Game (Capital Intrigue, #1)</title>\n    <author>\n      <id type="integer">7913140</id>\n      <name>Rachel Dylan</name>\n    </author>\n    <image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1563377096l/46125032._SX98_.jpg</image_url>\n    <small_image_url>https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1563377096l/46125032._SY75_.jpg</small_image_url>\n  </best_book>\n</work>\n\n    </results>\n</search>\n\n</GoodreadsResponse>'


def search_by_query(query, page_no=1, search_on='all'):
    """
    :param query: search term
    :param page_no: Which page to return (default 1)
    :param search_on: Field to search, one of 'title', 'author', or 'all' (default is 'all')
    :return: first 20 search results
    """
    param = {'q': query, 'page': page_no, 'search[field]': search_on, 'key': KEY}
    return_data = []
    xml_data = requests.get(BASE_URL, param)
    root = ET.fromstring(xml_data.content)
    for element in root.iter('work'):
        temp = dict()
        for j in element.iter():
            if (j.tag in SEARCH_TAG_LIST):
                temp[j.tag] = j.text
        return_data.append(temp)
    return return_data


def getbase64(filename):
    return str(base64.b64encode(open(filename, 'rb').read()))

def getES(env = 'local'):
    '''

    :param env: local or dev
    :return: es object
    '''
    if env=='local':
        return Elasticsearch()
    if env=='dev':
        bonsai = BONSAI_URL
        auth = re.search('https\:\/\/(.*)\@', bonsai).group(1).split(':')
        host = bonsai.replace('https://%s:%s@' % (auth[0], auth[1]), '')

        # optional port
        match = re.search('(:\d+)', host)
        if match:
            p = match.group(0)
            host = host.replace(p, '')
            port = int(p.split(':')[1])
        else:
            port = 443

        # Connect to cluster over SSL using auth for best security:
        es_header = [{
            'host': host,
            'port': port,
            'use_ssl': True,
            'http_auth': (auth[0], auth[1])
        }]

        # Instantiate the new Elasticsearch connection:
        es = Elasticsearch(es_header)

        # Verify that Python can talk to Bonsai (optional):
        es.ping()
        return es


def create_data_dump():
    SAMPLE_QUERY = ["potter", "sharma", "amish", "pie"]
    es = getES('dev')
    for i in SAMPLE_QUERY:
        for j in search_by_query(i):
            j["base64"] = getbase64('file.pdf')
            res = es.index(index='books_dummy', doc_type='book', body=j)
            print(res['result'])


if __name__ == '__main__':
    create_data_dump()
    # pprint.pprint(len(search_by_query("potter")))
